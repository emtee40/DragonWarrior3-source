ЧТО МОЖНО ИЗМЕНИТЬ

1. Изменить логику управления на более современную. Меню должно использоваться только для настроек, просмотра и надевания шмоток и статусов. Действия на карте должны происходить автоматически. В идеале с автоопределением точки проверки (кнопка А в пустом месте или на сундуке начинает поиск под ногами, перед персонажем или магазином начинает разговор, перед дверью открывает ее, если есть соответствующий предмет в инвентаре) либо вручную (А - разговор, В - поиск без проверки положения).

ЧТО СДЕЛАТЬ

1. Файловая система
1.1 Совместить номра банков и индексы функций в одной записи в файловой системе для возможности произвольной автоматической сортировки и чистки (добавить банк в макрос PTR_IDX). Соответственно потребуется выбирать индексы банками по 128 индексов в каждом из 256-байтных блоков.
1.2 Финальная оптимизация и очистка индексов файловой системы.
1.3 Возможно использование отдельной таблицы и соответственно упрощенных функций выборки для данных, читаемых из внешних банков через файловую систему. Либо перемещение их в начало таблицы файловой системы, чтобы гарантировать нахождение их индексов в первых 256 элементах, так как все текущие функции чтения данных рассчитаны только на 8-битные индексы.
1.4 Фсе системные функции подразумевают передачу только 8-битного аргумента, старшие биты при этом устанавливаются исходя из номера самой вызываемой функции. Но, после упрощения дешифрации BRK опкодов, имеется возможность иметь как минимум 3 лишних бита для использования в качества старших битов аргумента.

2. Функции быстрого доступа к файловой системе через SRAM
2.1 Фунция для ускоренного доступа _sys_safe_select может работать только с первыми 256 индексами файловой системы. Отдельной проверкой  осуществляется вызов единственного индекса за этими пределами - 167. При оптимизации индексов файловой системы перенести ее в начальную область, чтобы избавиться от дополнительных пересчетов индекса и проверок на конкретный вызов, упростить _sys_safe_select.
2.2 В идеале убрать функции быстрого доступа из SRAM и использовать для этого простые BNE переходы в системном банке.

8. Упростить систему вывборки и вывода сообщений. Используются системные функции двух типов. Одни напрямую вызываются из банка D, куда и возвращаются для выбора индекса сообщений по отдельной таблице. Другие используют системные функции, определяющими старшую часть индекса сообщения и аргументом, задающим младшую. В результате получается довольно странная каша из разного рода индексов, вместо указания одного конкретного индекса конкретного сообщения. До кучи сами функции вывода сообщений довольно разветвлены и вложены друг в друга в разной степени.
8.1 

ЧТО СДЕЛАНО

1. Общая очистка кода и неиспользуемых данных, как обычно.
2. Музыкальный банк перемещен в нижний блок памяти, убраны дальние вложенные вызовы звуковых библиотек через костыли. Теперь вызовы делаются напрямую через файловую систему.
3. Данные, содержащие только одиночные 16-битные указатели (для загрузки раздельно младшей и старшей части), преобразованы в непосредственную загрузку младшей и старшей частей указателя в регистры.

4. Файловая система
4.1 Исключено использование файловой системы для хранения и вычитки указателей на блоки данных во внешних банках. Так как все адреса видны глобально на этапе ассемблирования, все подобные использования указателей заменены прямым заданием адреса в регистрах. Все соответствующие функции, ставшие ненужными, выпилены.
4.2 Проиндексированы таблицы указателей на функциях во внешних банках и общая таблица файлов. Таблицы указателей очищены от пустых, неиспользуемых функций и указателей, а также от дубликатов указателей.
4.3 BRK опкоды заменены на макросы с автоматическим расчетом индекса функции в файловой системе. Константы индексов файловой системы, использующиеся в функциях для непрямого вызова или чтения внешних процедур и данных заменены на мнемонические. Возможен произвольный перенос и оптимизация индексов файловой системы.
4.4 Таблица номеров банков функций расширена с 4-битных индексов на 8-битные, огриничения на вызов внешних банков старшего 256К блока отсутствуют.
4.5 В общую таблицу вызовов добавлены функции старшего 256К блока, BRK опкоды с командой непосредственного перехода для старших банков больше не используются.
4.6 Убрано разделение на дальние и библиотечные вызовы из обработчика BRK переходов, теперь они все одинаково вызывают только системные функции, каждая из которых имеет свой формат аргумента и предназначение. Упрощена выборка номер индекса функции.

5. Функции быстрого доступа к файловой системе через SRAM
5.1 Переделан формат ссылок быстрого доступа без использования параметрических чтений индекса. Соответствующие функции, ставшие ненужными, удалены.
5.2 Отдельная быстрая ссылка для доступа к функциям файловой систем по заданному в регистре индексу _sys_safe_select перенесена из SRAM в системный банк и упрощена (из двух дополнительных индексов 166 и 167, первый никогда не использовался в этой процедуре).

НОВЫЕ БАГИ

